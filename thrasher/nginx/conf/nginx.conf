##################################################################################################################
# brief: nginx conf file
# date: 2016-04-01
# creator: hy
# note: refer to https://www.linode.com/docs/websites/nginx/configure-nginx-for-optimized-performance
# changes:
#
##################################################################################################################
user root root;
worker_processes 2;
error_log logs/error.log;

events {
   worker_connections  19999; # It's the key to high performance - have a lot of connection available
   # use epool;
   # multi_accept on;
}

worker_rlimit_nofile   40000; # Each connection needs a filehandle (or 2 if you are proxying)
# Total amount of users you can serve = worker_processes * worker_connections

http {   
   # GZIP options refering to: https://gist.github.com/fukata/3950740
   gzip on;
   gzip_http_version 1.1;
   gzip_types text/html 
	    	     text/css
                     application/x-javascript  
                     application/javascript 
                     text/javascript 
                     text/plain 
                     text/xml 
                     application/json 
                     application/xhtml+xml
                     application/rss+xml
                     application/atom_xml
                     application/javascript
                     application/x-javascript
                     application/vnd.ms-fontobject 
                     application/x-font-opentype 
                     application/x-font-truetype 
                     application/x-font-ttf 
                     application/xml 
                     font/eot 
                     font/opentype 
                     font/otf 
                     image/svg+xml 
                     image/vnd.microsoft.icon;
   gzip_comp_level   6;
   gzip_disable      "MSIE [1-6]\.";
   gzip_disable      "Mozilla/4";
   gzip_vary         on;  
   gzip_proxied      any;
   gzip_min_length   1000;

   keepalive_timeout 2400;
   keepalive_requests 100000;
   sendfile         on;
   tcp_nopush       on;
   tcp_nodelay      on;

   #client_body_buffer_size    128k;
   #client_max_body_size       10m;
   #client_header_buffer_size    1k;
   #large_client_header_buffers  4 4k;
   #output_buffers   1 32k;
   #postpone_output  1460;
		
   #client_header_timeout  10m;
   #client_body_timeout    10m;
   #send_timeout           10m;
		
   #open_file_cache max=1000 inactive=20s;
   #open_file_cache_valid 30s;
   #open_file_cache_min_uses 5;
   #open_file_cache_errors off;

   init_by_lua
	' 
           cjson = require("cjson")  
	';

   proxy_cache_path /tmp levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m use_temp_path=off;

   server {
 	 
        #root /home/hyebj/work/thrasher/web/app;
        listen 8081;
        location / {        
           if ($request_method = OPTIONS ) {
               add_header Access-Control-Allow-Origin  "*";
               add_header Access-Control-Allow-Methods "POST, GET, PUT, UPDATE, DELETE, OPTIONS";
               add_header Access-Control-Allow-Headers "Authorization";
               add_header Access-Control-Allow-Credentials  "true";
               add_header Content-Length 0;
               add_header Content-Type text/plain; 
               return 200;
	   }
	   # index ../web/miniist-index.html
           default_type  text/html;
           lua_code_cache off;   # only for development
	   #proxy_cache my_cache;	
	   #proxy_cache_valid 2h; 	
           proxy_pass http://127.0.0.1:3001;
           proxy_redirect     off;
           proxy_set_header   Host             $host;
           proxy_set_header   X-Real-IP        $remote_addr;
           proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;

           #proxy_connect_timeout      180;
           #proxy_send_timeout         180;
           #proxy_read_timeout         180;
           #proxy_buffer_size          4k;
           #proxy_buffers              4 32k;
           #proxy_busy_buffers_size    64k;
           #proxy_temp_file_write_size 64k;
	   #proxy_temp_path            /etc/nginx/proxy_temp;
	}

        # caching static picture files [ 2016-04-21 added by thinkhy ] 
        #location ~* \.(gif|jpg|png)$ {  
        #    expires 30d;   
	#}

        location ~ ^/(join|login|logout|user|user/password)(\?.*)?$ {        
            if ($request_method = OPTIONS) {
                rewrite ^(.*)$ / last;
	    }
            # default_type  text/html;
            lua_code_cache off;   # only for development
            proxy_pass http://198.11.174.68:8081
            proxy_redirect     off;
            proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            #proxy_connect_timeout      90;
            #proxy_send_timeout         90;
            #proxy_read_timeout         90;
            #proxy_buffer_size          4k;
            #proxy_buffers              4 32k;
            #proxy_busy_buffers_size    64k;
            #proxy_temp_file_write_size 64k;
	    #proxy_temp_path            /etc/nginx/proxy_temp;
	}

        location ~ ^/(testsuite|testsuites)(\?.*)?$ {        
            if ($request_method = OPTIONS) {
                rewrite ^(.*)$ / last;
	    }
            # default_type  text/html;
            lua_code_cache off;   # only for development
            proxy_pass http://198.11.174.68:8081;
            proxy_redirect     off;
            proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	}

        location ~ ^/(workload|workloads)(\?.*)?$ {        
            if ($request_method = OPTIONS) {
                rewrite ^(.*)$ / last;
	    }
            # default_type  text/html;
            lua_code_cache off;   # only for development
            proxy_pass http://198.11.174.68:8081;
            proxy_redirect     off;
            proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
	}
   }
}

